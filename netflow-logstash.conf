input {

	# Receive Netflow
	tcp {
		port => 5544
		type => "netflow"
	} 
}

filter {
	# Parse JSON fields from message field
	json {
		source => "message"
	}
	
	# Assign protocol names to custom application ports
	if [L4_DST_PORT] == 1801 {
		mutate {
			update => { "L7_PROTO_NAME" => "MSMQ" }
		}
	}

	if [L4_DST_PORT] == 5601 {
		mutate {
			update => { "L7_PROTO_NAME" => "Kibana" }
		}
	}
	
	if [L4_DST_PORT] == 8091 {
		mutate {
			update => { "L7_PROTO_NAME" => "Couchbase" }
		}
	}

	if [L4_DST_PORT] == 8443 {
		mutate {
			update => { "L7_PROTO_NAME" => "TeamCity" }
		}
	}	

	if [L4_DST_PORT] == 9200 {
		mutate {
			update => { "L7_PROTO_NAME" => "Elasticsearch" }
		}
	}		
	
	if [L4_DST_PORT] == 9876 {
		mutate {
			update => { "L7_PROTO_NAME" => "Acronis" }
		}
	}

	if [L4_SRC_PORT] == 4500 and [L4_DST_PORT] == 4500 {
		mutate {
			update => { "L7_PROTO_NAME" => "IPsec" }
		}
	}	
	# End - Assign protocol names to custom application ports
	
	## Create Geo info based on IP ##
	# Netflow source IP
	geoip {
		source => "IPV4_SRC_ADDR"
		target => "src_geoip"
		fields => ["country_code2", "country_name", "continent_code", "region_name", "real_region_name", "city_name", "postal_code", "timezone", "location"]
	}
	
	# Netflow destination IP
	geoip {
		source => "IPV4_DST_ADDR"
		target => "dst_geoip"
		fields => ["country_code2", "country_name", "continent_code", "region_name", "real_region_name", "city_name", "postal_code", "timezone", "location"]
	}
	## End - Create Geo info based on IP ##
		
	## Assign network tags based on IP - Applied to all sources ##
	
	# Tag all private IP ranges	
	cidr {
		add_tag => ["ip-src-PrivateIP"]
		address => ["%{IPV4_SRC_ADDR}"]
		network => ["10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "11.12.13.0/24", "11.12.14.0/24"]
	}
	
	cidr {
		add_tag => ["ip-dst-PrivateIP"]
		address => ["%{IPV4_DST_ADDR}"]
		network => ["10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "11.12.13.0/24", "11.12.14.0/24"]
	}
	
	cidr {
		add_tag => ["ip-src-MLPublicIP"]
		address => ["%{IPV4_SRC_ADDR}"]
		network => ["12.106.86.0/24", "12.184.142.0/24", "198.185.62.0/24"]
	}
	
	cidr {
		add_tag => ["ip-dst-MLPublicIP"]
		address => ["%{IPV4_DST_ADDR}"]
		network => ["12.106.86.0/24", "12.184.142.0/24", "198.185.62.0/24"]
	}
	
	cidr {
		add_tag => ["ip-MeridianLink"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["172.30.28.0/23", "172.30.26.0/23", "11.12.13.0/24", "11.12.14.0/24"]
	}
	
	cidr {
		add_tag => ["ip-MiddleEarth"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["10.11.13.0/24"]
	}
	
	cidr {
		add_tag => ["ip-MiddleEarthLQB"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["10.11.33.0/24"]
	}

	cidr {
		add_tag => ["ip-MRoamers"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["172.30.40.0/24"]
	}
	
	cidr {
		add_tag => ["ip-Moria"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["10.11.14.0/24"]
	}	
	
	cidr {
		add_tag => ["ip-Z1"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["10.11.18.0/24"]
	}	
	
	cidr {
		add_tag => ["ip-KVM-Consoles"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["172.22.22.0/23"]
	}
	
	cidr {
		add_tag => ["ip-MLSwitch"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["172.22.21.0/24"]
	}
	
	cidr {
		add_tag => ["ip-SAN"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["10.99.1.0/24"]
	}
	
	cidr {
		add_tag => ["ip-17x"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["10.11.17.0/24"]
	}
	
	cidr {
		add_tag => ["ip-LB"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["10.11.60.0/24"]
	}
	
	cidr {
		add_tag => ["ip-VPN"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["10.184.1.0/24"]
	}
	
	cidr {
		add_tag => ["ip-Ext"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["12.106.86.0/24"]
	}
	
	cidr {
		add_tag => ["ip-Ext2"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["12.184.142.0/24"]
	}
	
	cidr {
		add_tag => ["ip-ExtTW"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["173.227.56.0/24"]
	}
	
	cidr {
		add_tag => ["ip-ExtL3"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["8.38.36.0/24"]
	}
	
	cidr {
		add_tag => ["ip-ARIN-Local"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["198.185.62.0/24"]
	}
	
	cidr {
		add_tag => ["ip-ARIN-Offsite"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["198.185.63.0/24"]
	}
	
	cidr {
		add_tag => ["ip-DMZ40"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["10.11.40.0/24"]
	}
	
	cidr {
		add_tag => ["ip-DMZ41"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["10.11.41.0/24"]
	}
	
	cidr {
		add_tag => ["ip-DMZ45"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["10.11.45.0/24"]
	}
	
	cidr {
		add_tag => ["ip-Logging"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["192.168.50.0/24"]
	}
	
	cidr {
		add_tag => ["ip-216xVPN"]
		address => ["%{IPV4_SRC_ADDR}", "%{IPV4_DST_ADDR}"]
		network => ["216.34.238.0/24"]
	}	
	## End - Assign network tags based on IP ##
	
	## Must be last filter!!! ##
	mutate {
		remove_field => ["message"]
	}	
}

output {
	# Default index for netflow and any unfiltered data
	elasticsearch {
		hosts => ["127.0.0.1:9200"]
		index => "netflow-%{+YYYY.MM.dd}"
	}
}
